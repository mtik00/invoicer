{% set current_page = 'invoices' %}
{% set help_step = '6' %}
{% from "_modals.html" import render_delete_modal %}
{% extends "base.html" %}
{% block body %}


<form method="GET">
    {{ form.hidden_tag() }}
    <div class="w3-bar w3-theme-d2" data-step='6' data-intro='This is where you create/modify invoices'>
        {%- if previous_id -%}
        <a class="w3-bar-item w3-button" href="{{ url_for('invoice_page.invoice_by_number', invoice_number=previous_id)}}">Previous</a>
        {% else -%}
        <button class="w3-bar-item w3-button" disabled>Previous</button>
        {% endif %}

        {%- if next_id -%}
        <a class="w3-bar-item w3-button" href="{{ url_for('invoice_page.invoice_by_number', invoice_number=next_id)}}">Next</a>
        {% else -%}
        <button class="w3-bar-item w3-button" disabled>Next</button>
        {% endif %}

        <div class="w3-dropdown-hover">
            <button class="w3-button" data-intro="Edit the invoice: Add/remove items, mark as submitted/paid, etc">Modify</button>
            <div class="w3-dropdown-content w3-bar-block w3-card-4 list-group" id="invoice_edit_dropdown">
                <a class="w3-bar-item w3-button list-group-item" href="{{ url_for('invoice_page.update', invoice_number=invoice.number) }}"><i class="fa fa-pencil fa-fw" aria-hidden="true"></i>&nbsp;Edit</a>
                {% if (not invoice_obj.submitted_date) -%}
                <a class="w3-bar-item w3-button list-group-item" href="{{ url_for('invoice_page.create_item', invoice_number=invoice.number) }}"><i class="fa fa-plus fa-fw" aria-hidden="true"></i>&nbsp;Add Item</a>
                <a class="w3-bar-item w3-button list-group-item" href="{{ url_for('invoice_page.delete_items', invoice_number=invoice.number) }}"><i class="fa fa-minus fa-fw" aria-hidden="true"></i>&nbsp;Delete Items</a>
                {% elif (config['DEBUG'] or session['user_debug']) %}
                <a class="w3-bar-item w3-button list-group-item" href="{{ url_for('invoice_page.create_item', invoice_number=invoice.number) }}"><i class="fa fa-plus fa-fw" aria-hidden="true"></i>&nbsp;Add Item (only allowed in debug mode)</a>
                <a class="w3-bar-item w3-button list-group-item" href="{{ url_for('invoice_page.delete_items', invoice_number=invoice.number) }}"><i class="fa fa-minus fa-fw" aria-hidden="true"></i>&nbsp;Delete Items (only allowed in debug mode)</a>
                {% else -%}
                <button class="w3-bar-item w3-button list-group-item" formaction="#" disabled><i class="fa fa-plus fa-fw" aria-hidden="true"></i>&nbsp;Add Item</button>
                <button class="w3-bar-item w3-button list-group-item" formaction="#" disabled><i class="fa fa-minus fa-fw" aria-hidden="true"></i>&nbsp;Delete Items</button>
                {% endif %}
                <input type="hidden" id="delete_modal_target" name="delete_modal_target" value="" data-submit-url="{{url_for('invoice_page.delete', invoice_number=invoice.number) }}">
                <span onclick="show_delete_modal();" class="w3-bar-item w3-button w3-red"><i class="fa fa-trash fa-fw" aria-hidden="true"></i>&nbsp;Delete Invoice</span>
            </div>
        </div>

        {% if show_pdf_button -%}
        <a class="w3-bar-item w3-button"data-intro="Download the invoice as a PDF for offline-viewing"
        {% if pdf_ok -%}
        href="{{ url_for('invoice_page.to_pdf', invoice_number=invoice.number)}}" formtarget="_blank">
        {%- else -%}
        href="#" disabled>
        {%- endif -%}
        Download PDF</a>
        {%- endif -%}

        {% if can_submit and ((not invoice_obj.paid_date) or config['DEBUG'] or session['user_debug']) %}
        <span onclick="document.getElementById('submit-modal').style.display='block'" class="w3-bar-item w3-button" data-intro="Various options for submitting the invoice">Submit Invoice</span>
        {% endif -%}
        
        <a class="w3-bar-item w3-button w3-right" href="{{url_for('invoice_page.create')}}">Add New Invoice</a>
    </div>
</form>

<!-- Submit Modal -->
<div id="submit-modal" class="w3-modal">
    <div class="w3-modal-content">
        <header class="w3-container w3-blue"> 
            <span onclick="document.getElementById('submit-modal').style.display='none'" 
            class="w3-button w3-blue w3-xlarge w3-display-topright">&times;</span>
            <h2>Submit Invoice</h2>
        </header>

        <div class="w3-container">
            {% if to_emails -%}
            <p>Email submissions will be sent to: {{to_emails}}</p>
            {% else -%}
            <p>This customer has no email address(es) associated with it</p>
            {% endif -%}
        </div>

        <form action="{{url_for('invoice_page.submit_invoice', invoice_number=invoice.number)}}" method="POST">
            <div class="w3-container w3-form">
                {% if to_emails and invoice_obj.submitted_date -%}
                <p><input type="submit" id="email_btn" class="w3-button w3-white w3-border w3-left-align" style="width: 75%"  name="email" value="Email only (invoice already marked as submitted)" /></p>
                {% elif to_emails %}
                <p><input type="submit" id="email_btn" class="w3-button w3-white w3-border w3-left-align" style="width: 75%"  name="email" value="Email and mark invoice as submitted" /></p>
                {% endif %}

                {% if not invoice_obj.submitted_date %}
                <p><input type="submit" class="w3-button w3-white w3-border w3-left-align" style="width: 75%"  name="mark" value="Mark invoice as submitted (do not send email)" /></p>
                {% endif %}
            </div>
        </form>

        <div class="w3-container w3-light-grey w3-padding">
            <p><button id='submit-close-button' class="w3-button w3-right w3-white w3-border">Cancel</button></p>
        </div>
    </div>
</div>

{{ render_delete_modal() }}

<div id="email-modal" class="w3-modal">
    <div class="loader w3-display-middle"></div>
</div>

<div class="fluidMedia">
    <iframe src="{{url_for('invoice_page.raw_invoice', invoice_number=invoice.number)}}" frameborder="1" data-step='7' data-intro='This is the HTML representation of your invoice that will be submitted and/or converted to PDF (if available)'></iframe>
</div>

{% endblock %}

{% block extrascripts %}
{% include '_delete_modal.js' %}
<script>
    $( document ).ready(function() {
        // Handle the email submit button
        $('#email_btn').on('click', function(event) {
            // Close the submit modal
            $('#submit-modal').css({ 'display': "none" });

            // Show the loading modal
            $('#email-modal').css({ 'display': "block" });
        });
        
        // Close the submit modal if the button is clicked
        $( "#submit-close-button" ).click(function() {
            $('#submit-modal').css({ 'display': "none" });
        });

        // Close the submit modal when the escape key is pressed
        $(document).on('keydown',function(event) {
            if (event.keyCode == 27) {
                $('#submit-modal').css({ 'display': "none" });
             }
         });

        // Close the submit modal when clicking outside of the window
        $(window).on('click', function(event){
            if ((event.target == $('#submit-modal').get()[0]) || (event.target == $('#delete-modal').get()[0])) {
                $('#submit-modal').css({ 'display': "none" });
            }
        });

    });
</script>
{% endblock%}